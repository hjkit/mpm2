#!/usr/bin/expect -f
#
# SSH test harness for MP/M II emulator
#
# Usage: ./test_ssh.exp [port] [command...]
#
# Examples:
#   ./test_ssh.exp                    # Interactive mode
#   ./test_ssh.exp 2222 dir           # Run DIR command
#   ./test_ssh.exp 2222 dir stat      # Run DIR then STAT
#

set timeout 30
set port [lindex $argv 0]
if {$port eq ""} {
    set port 2222
}

# Get commands from remaining args
set commands [lrange $argv 1 end]

# Disable host key checking for testing
set env(SSH_OPTIONS) "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

log_user 1

puts "=== MP/M II SSH Test Harness ==="
puts "Connecting to port $port..."

# Spawn SSH connection with PTY
spawn ssh -tt -p $port -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null user@localhost

# Wait for MP/M II prompt (with optional banner on first connect)
# On reconnection, we might just get the prompt without the full banner
expect {
    -re {\d+[A-P]>} {
        puts "\n>>> Got prompt!"
    }
    -re {MP/M II Console \d+} {
        puts "\n>>> Saw console banner"
        exp_continue
    }
    -re {MP/M II V2\.\d+} {
        puts "\n>>> Saw MP/M version"
        exp_continue
    }
    -re {Copyright} {
        puts "\n>>> Saw copyright"
        exp_continue
    }
    timeout {
        puts "\n>>> TIMEOUT waiting for prompt"
        exit 1
    }
    eof {
        puts "\n>>> Connection closed unexpectedly"
        exit 1
    }
}

# If no commands given, go interactive
if {[llength $commands] == 0} {
    puts "\n>>> Interactive mode - type commands, Ctrl+] to exit"
    interact
    exit 0
}

# Run each command
foreach cmd $commands {
    puts "\n>>> Sending command: $cmd"
    send "$cmd\r"

    # Wait for command to echo and then next prompt
    expect {
        -re {\d+[A-P]>} {
            puts "\n>>> Got prompt after $cmd"
        }
        timeout {
            puts "\n>>> TIMEOUT waiting for response to: $cmd"
            exit 1
        }
        eof {
            puts "\n>>> Connection closed after: $cmd"
            exit 1
        }
    }
}

puts "\n>>> All commands completed successfully"

# Just close the connection - MP/M II doesn't have an exit command
puts "\n>>> Closing connection"
close
wait

exit 0
